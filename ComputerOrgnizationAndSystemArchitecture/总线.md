# 总线

## 类型

* **芯片传输总线**：连接芯片内部的各个部分
	* 例：CPU中连接寄存器、ALU等部分
* <span style = 'color : red'>**系统总线**</span>：连接CPU、存储器、IO控制器和其他功能设备
* **通信总线**：连接主机和I/O设备，或连接**不同**的计算机系统

> Intel架构中的“系统总线”
>
> intel架构中的系统总线指的是：IO连接桥和CPU之间连接的总线，与上面所说的系统总线有略微不同（特指的系统总线



## 数据线、地址线和控制线

1. 数据线：在系统组件之间传输数据

	* 数据线的数量决定了一次**可以传输的数据**大小（数据的位数，一根一位）

2. 地址线：在数据线和I/O端口上指定数据的来源和去向

	* 地址线的数量决定了**寻址空间**的大小（地址的位数，一根一位）

	> 特例：可以将64位地址分成两次32位地址传输（先行地址后列地址

3. 控制线：控制对数据线和地址线的存取和使用

	* 时钟（clock）：用于总线同步操作
	* 总线请求（bus request）：表示模块需要获得对总线的控制
	* 总线允许（bus grant）：发出请求的设备已经被允许控制总线
	* 中断请求（interrupt request）：表示某个中断正在悬而未决
	* 中断响应（interrupt ACK）：未决的中断请求被响应
	* 存储器读（Memory Read）：使所寻址单元的数据放到总线上
	* 存储器写（Memory Write）：引起总线上的数据写入被寻址的单元
	* I/O读（I/O Read）：使被寻址的I/O端口的数据放到总线上
	* I/O写（I/O Write）：引起总线上的数据输出到被寻址的I/O端口



## 总线上数据传输的特点

总线可以被多个设备监听，但同一时刻只能由一个设备发送数据

* 如果同一时刻多个设备同时发送数据，会造成数据之间的混淆
* 使用总线进行数据传输
	* 如果连在总线上的某个设备希望向另一个设备发送数据，需要：
		1. **获得总线的使用权**
		2. 通过总线传输数据
	* 如果连在总线上的某个设备希望向另一个组件请求数据，需要：
		1. **获得总线的使用权**
		2. 通过总线向另一个设备发送请求，等待另一个设备发送数据
* 某个设备**已经**在使用总线时，其他设备不能获得总线的使用权（无论优先级



## 设计要素

用途：专用总线，复用总线

仲裁（arbitration）：集中式，分布式

时序：同步时序/异步时序/半同步时序/分离事务

总线带宽和数据传输率



### 用途

1. 专用（dedicated）总线：始终只负责一项功能，或始终分配给特定的计算及组件。
	* 优点：高吞吐量，减少总线冲突
	* 缺点：增加了系统的规模和成本
2. 复用（multiplexed）总线：将同一线路用于多种用途
	* 优点：使用的布线数量少，节省空间和成本
	* 缺点：每个模块需要更复杂的控制电路，且共享可能会降低性能



### 仲裁

总线仲裁：当多个设备需要与总线通信时，通过某种策略选择一个设备

平衡因素：

1. 优先级：优先级高的设备优先被服务
2. 公平性：优先级最低的设备不能一直被延迟

#### 仲裁方案

1. 集中式（centralized）：由**仲裁器（arbiter）**或**总线控制器（bus controller）**负责分配总线使用权

  * 链式查询/菊花链（daisy chain）

    > 所有的设备都是串行连接的，并将允许信号从优先级最高的设备下发到优先级最低的设备（从高到低
    >
    > 总线仲裁器收到请求后，在**总线不忙**的情况下，发起允许信号
    >
    > 如果某个设备收到了允许信号并且发起了总线请求，该设备将总线设置为**繁忙状态**，允许信号将不再被进一步传递。（繁忙线是双向的，可以由设备发起也可以发送到设备
    >
    > 优点：确定优先级很简单（优先级高在前面，优先级低在后面），可以很灵活地添加设备
    >
    > 缺点：不能保证公平性，对电路故障敏感（串连），限制总线的速度
    >
    > ![image-20211206191415224](C:/Users/Zyi/AppData/Roaming/Typora/typora-user-images/image-20211206191415224.png)

    流程：

    1. 首先设备检查繁忙线是否被设成忙，如果没有被设成忙则发起请求信号，
    2. 总线仲裁器收到请求信号后，检测繁忙线是否被设为忙，如果不忙的话则发起允许信号。
    3. 允许信号从优先级高的设备一直往优先级低的设备传递（通过允许线串连起来），遇到发出请求信号的设备就停止，该设备将繁忙线设成忙，同时开始使用总线

  * 计数器查询（query by a counter）

    > 将总线允许线替换为**设备ID线**（$\log_2n$根 -- $n$个设备）
    >
    > 如果总线空闲，总线仲裁器通过设备ID线发送计数
    >
    > 如果当前发送请求的设备ID等于裁决器当前的计数，裁决器将停止计数，设备将总线设置为忙
    >
    > 与链式的区别：报数顺序并不固定，可以更改，即同一个设备的**设备ID**在每次请求时可能不同，这样就可以灵活的确定设备的优先级
    >
    > 优点：通过使用不同的初始计数，可以灵活地确定设备优先级
    >
    > * 强调优先级：从1开始
    > * 强调公平性：从下一个设备的ID开始
    >
    > 对电路故障不敏感。
    >
    > 缺点：需要添加设备ID线，需要解码和比较设备ID信号，限制总线的速度
    >
    > ![image-20211206191440810](C:/Users/Zyi/AppData/Roaming/Typora/typora-user-images/image-20211206191440810.png)

  * 独立请求（independently request）

	> 每个设备都有自己的总线请求线和总线允许线
	>
	> 当一个设备请求总线时，它通过总线请求线将请求信号发送给总线仲裁器
	>
	> 总线仲裁器决定哪个设备可以使用总线
	>
	> * 决定策略：固定优先级，公平链式，LRU，FIFO，...
	>
	> 优点：快速响应，可编程的优先级
	>
	> 缺点：复杂的控制逻辑，更多的控制电路
	>
	> ![image-20211206191459891](C:/Users/Zyi/AppData/Roaming/Typora/typora-user-images/image-20211206191459891.png)

2. 分布式（distributed）：每个设备都包含访问控制逻辑，**各设备共同作用**分享总线

	* 自举式

	  > **固定优先级**
	  >
	  > 每个设备在其总线请求线上发送请求，最低优先级的设备没有请求线
	  >
	  > 每个设备自行判断自己是否在请求总线的设备中优先级最高
	  >
	  > 过程：优先级高的设备会发送信号，比该设备优先级低的设备会监听该信号，如果优先级高的设备要使用总线，就会发送信号，优先级低的设备就不能使用总线（监听到了优先级高的设备要使用总线的信号
	  >
	  > ![image-20211206191223594](C:/Users/Zyi/AppData/Roaming/Typora/typora-user-images/image-20211206191223594.png)
	
	* 冲突检测
	
		> 当一个设备想要使用总线时，它会检查宗贤是否繁忙。如果总线空闲，设备使用总线
		>
		> 冲突：如果两个设备发现总线空闲，它们可能同时使用总线
		>
		> * 在传输数据时，设备会监听总线，检查是否存在冲突
		> * 如果发生冲突，所有使用总线的设备将停止数据传输，并分别在随机间隔时间后再次请求总线。



### 时序

确定每个总线事务的开始和结束时间

> 总线事务：地址 + 数据 + ... + 数据

类型：

1. 同步时序：事件的发生由时钟决定
2. 异步时序：一个事件的发生取决于前一个事件的发生
3. 半同步：同步时序和异步时序相结合
4. 分离事务：设备准备数据期间释放总线



#### 同步时序

优点：更容易实现和测试

缺点：所有设备共享同一个时钟，总线长度收到时钟偏差的限制



#### 异步时序

1. 握手策略：ready线和ACK线进行三次握手变成全互锁

	> 非互锁：No interlock
	>
	> 半互锁：Semi-interlock
	>
	> 全互锁：interlock

2. 优点：可以灵活地协调速度不同的设备

3. 缺点：对噪声敏感



#### 半同步时序

为了减少噪声的影响，在异步计时中使用时钟。

准备和响应信号在时钟上升沿有效

结合同步和异步定时的优点。



#### 分离事务

将一个总线事件分离为两个过程

优点：增加总线利用率

缺点：增加每个总线事件的持续时间和系统复杂度



### 总线带宽和数据传输数率

1. **总线带宽**（bus bandwidth）：总线**最大**数据传输速率

	> 不要考虑总线仲裁，地址传输等因素

2. 数据传输速率

	> 考虑地址传输，握手等因素

3. 总线宽度：组成总线的线数（**与总线带宽不同**）

	> 数据总线越宽，一次传输的数据位数就越多
	>
	> 地址总线越多，一次传输的地址位数就越多

#### 提高总线的数据传输率

1. 提高时钟频率
2. 增加数据总线宽度
	* 每次传输更多的数据（成本：更多的总线线路
3. 块传输
	* 传输一次地址就传输一块数据（成本，高复杂性
4. 分离总线事务
	* 减少总线空闲时间（成本：复杂性高，增加每个事务的持续时间
5. 分离地址线和数据线
	* 同时传输地址和数据（成本：更多的总线线路



### 总线层次结构

#### 单总线结构

* CPU、存储器和I/O模块都连接到一条<span style='color: red'>**系统总线**</span>
* 优点：简单、易于扩展
* 缺点：
	* 连接的设备越多，总线长度越大，传输延迟也就越大
	* 聚集的传输请求接近总线容量后，总线成为瓶颈

#### 双总线结构I

* 在CPU和存储中间增加一个<span style='color: red'>**存储器总线**</span>
* 优点：增加CPU和存储器之间的

#### 双总线结构II

* 将系统总线分为存储器总线、**I/O总线** 和 **IOP**（input/output processor）
* 优点：降低I/O对总线的负担

#### 多总线结构I

* 在 双总线结构II 的基础上增加一个<span style='color: red'>**本地总线（local bus）**</span>来连接CPU和cache
* 优点：分离了 CPU 和 I/O 的交互

#### 多总线结构II

* 将系统总线分为存储器总线、I/O总线和<span style='color:red'>**DMA总线**</span>

* 优点：增加I/O效率

#### 多总线结构III

* 增加一个高速I/O