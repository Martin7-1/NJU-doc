# 分布式系统：计算和存储

## 分布式计算

### 分布式计算概述

* 集中式计算：完全依赖一台大型的中心计算机的处理能力，即主机，与其相连的终端设备具有各不相同非常低的计算能力。实际上大多数终端完全不具有处理能力，仅作为输入输出设备使用。
* 分布式计算：多个通过网络互联的计算机都具有一定的计算能力，他们相互之间传递数据，实现信息共享，协作共同完成一个处理任务。
  * 中国科学院：分布式计算就是在两个或多个软件互相共享信息，这些软件既可以在同一台计算机上，也可以在通过网络连接起来的多台计算机上运行
  * 优势：稀有资源实现共享；在多台计算机上平衡计算负载；将程序放在最适合它的计算机上运行。
* 分布式系统：将海量计算能力才能处理的问题拆分成许多小块，将小块分配给同一套系统中不同的计算机节点处理，最后将分开计算的结果合并得到最终结果的系统。
通过网络消息实现数据通信与协调
* 分布式计算的一般步骤：设计分布式计算模型；分布式任务分配；编写并执行分布式程序【难点：计算任务划分 + 多节点通信】

> 难点：
>
> 1. 如何将复杂算法优化分解为适用于多个节点分别计算的小任务：特别是希望节点之间互不相干
> 2. 多数还是要相互通信的：消息队列；分布式存储

### 分布式计算理论基础

ACID原则：数据库事务正常执行的四个原则

1. 原子性（Atomicity） -- 事务中所有操作要么全都做完，要么都不做；只要一个操作失败，事务就失败，要回滚。
2. 一致性（Consistency） -- 数据库要处于原本的一致性状态。
3. 独立性（Isolation） -- 并发的事务不会相互影响，读数据不受影响，写数据也不能受到影响。
4. 持久性（Durability） -- 一旦事务提交后，它所作的修改应该永久保存在数据库上，即使宕机也不会丢失。

> 单台服务器上很容易实现 ACID，但是随着单台服务器无法满足大规模数据存储，使用集群代替单台服务器，ACID 难以得到**高效**的保证

**CAP理论**：一个分布式系统最多能够同时满足一致性（consistency），可用性（Availabilty）、分区容错性（Partition tolerance）中的两项

1. 一致性：一次操作之后，所有节点同一时间的数据完全一致。从客户端角度看，更新过的数据在不同进程如何获取的不同策略，决定了不同的一致性。
   1. 强一致性：更新过的数据，后续访问都能看到
   2. 弱一致性：能容忍后续的部分或者全部访问不到
   3. 最终一致性：如果经过一段时间后要求能访问到更新后的数据，称为最终一致性
2. 可用性：服务一直可用且在正常的响应时间内
3. 分区容错性：分布式系统遇到某节点或网络分区故障时，仍然能够对外提供满足一致性和可用性的服务。

* CA：但是分区始终存在，保证子系统 CA
* CP：导致某些节点无法使用
* AP：导致全局数据不一致，但是高可用

> 对于大多数大型互联网服务而言，节点故障、网络故障是常态，均采取保证 AP 的策略，对于一致性退而求其次，只保证最终一致性。

#### BASE理论 -- 追求最终一致性

1. Basically Available：基本可用，系统出现故障时，允许损失部分可用性，保证核心可用
2. Soft State：软状态：允许系统存在中间状态，但中间状态不会影响系统的整体可用性
3. Eventual Consistency：最终一致性-所有数据副本经过一定时间后，能最终达到一致的状态

#### 一致性算法（共识算法）

一个典型的场景是，在一个分布式数据库系统中，如果各节点的初始状态一致，每个节点执行相同的操作序列，那么他们最后能得到一个一致的状态。为保证每个节点执行相同的命令序列，需要在每一条指令上执行一个“一致性算法”以保证每个节点看到的指令一致。

1. 一台机器中多个进程/线程达成数据一致；
2. 分布式文件系统或者分布式数据库中多客户端并发读写数据；
3. 分布式存储中多个副本响应读写请求的一致性。

> 1. [基于消息传递的一致性算法Paxos](https://www.cnblogs.com/linbingdong/p/6253479.html)
> 2. [基于消息传递的一致性算法Raft](https://raft.github.io/)

## 分布式系统

### 特性

1. 容错性：
   1. 我们可能永远也造不出永远都不出故障的机器，更加难以开发出永不出错的软件，因为软件在一定程度上还依赖硬件的可靠性
   2. 在大规模分布式系统中完全检测和避免所有可能发生的故障是不可能的，因此需要系统能够在某些节点发生故障的情况下，利用容错机制避免整套系统服务都不可用。
2. 高可扩展性：能够在运行过程中自由地对系统内部节点或现有功能进行扩充，而不影响现有服务的运行。
3. 开放性：开放性决定给了一个系统是否具备自我扩展和与其他系统集成的能力；开放的接口+接口遵循洗衣 = 更好
4. 并发处理能力：分布式系统必须保证对象的操作在并发环境中能够安全的使用，保证数据一致性和系统高可用性。
5. 透明性：不需要让用户知晓分布式系统的内部细节，暴露给用户访问资源和服务的方式即可，用户将系统看作是一个整体。

### 类型

1. 分布式存储系统
   1. 结构化存储：事务处理系统或关系型数据库，数据划分为表、字段和表关系，如分布式 MySQL。
   2. 非结构化存储：强调很高的可扩展性，存储数据非常自由，典型代表是分布式文件系统，如 HDFS，GFS 等。
   3. 半结构化存储：为了解决半结构化数据随机访问性能差的问题，例如 NoSQL、Key-Value Store，对象存储。
   4. In-memory 存储：基于内存的存储系统，利用内存实现极高读写性能，例如 Memcached 和 Redis，做缓存。
   5. NewSQL：既具备结构化存储的 ACID 事务支持，又拥有 NoSQL 半结构化存储的强大可扩展能力。
2. 分布式计算系统
   1. 传统基于消息的系统：MPI（Message Passing Interface），非常灵活，对应用程序无约束
   2. Dataflow 系统：将计算抽象为高层算子，算子组合为有向无环图，有后端调度引擎进行并行化调度执行，Hadoop：MapReduce；Spark：更多类型的算子。框架对程序的结构有严格的约束，包括算子、输入输出等。
   3. 流式计算、图计算、分布式机器学习：Spark 都实现了这些类型的分布式计算。
3. 分布式资源管理系统：支持多种计算框架、高可扩展、高容错、高资源利用率、细粒度资源分配
   1. Yarn：Hadoop 2.0 版本，解决了原来 Hadoop 扩展性较差的问题，可以在框架下自定义算子。
   2. Apache Mesos：加州大学伯克利分校的一个研究项目，现在属于 Apahe 基金会的一个项目
   3. Spark Standalone：Spark 自带的简单的资源管理系统，负责跟踪集群状态并调度计算任务
   4. Kubernetes：Google 开发的一个强大的容器编排框架，用户通过 Kubernetes 管理容器，不需要和底层交互

### 案例：网格系统、P2P系统、区块链系统

#### 网格系统

* 一种能够整合的合作使用的由多家组织所拥有和管理的高端计算机、网格、数据库、实验设备等基础设施。
* 网格是一类并行、分布式系统，能够在运行时动态分享、选择、聚合地理散布的自治资源，依据它们的可用性、能力、性能、代价以及用户对服务质量的需求，构建满足用户需求的设备组合
* 网格技术解决的主要问题是合作研究中的社会问题，包括：
  * 改善分布式管理，同时保持对本地资源的全面控制。
  * 改善数据可用性，识别问题和数据访问模式的解决方案。
  * 为学者提供友好的环境，能够访问更大范围的地理上分布的设备，提高产率。

#### P2P系统

> 对等网格系统，Peer-to-Peer

P2P 系统是一种在对等者之间分配任务和工作负载的分布式应用架构的系统；所有参与者的角色相同，都对外共享它们拥有的一部分硬件资源，这些资源可以被系统内其他参与者访问。性质：

* 高度分散化：节点地理位置分散，系统资源的管理和任务处理也高度分散在各个节点
* 自组织性：系统按照相互默契的规则，各尽其责而又协调地自动地形成有序结构；加入节点只需广播例如 IP 地址等必要的基本信息即可，无需额外操作。
* 多管理域：最夸张的是每一个节点都由不同的组织、个人管理，每一个节点就是一个管理域。

> 特点（优点）：部署门槛低；增长速度快；容错性高；资源的丰富性和多样性高
>
> 应用：共享及分发文件；流媒体；网络电话；志愿计算等。

#### 区块链

* 一种去中心化、不可篡改、可追溯、多方共同维护的分布式数据库系统。
* 集成了 P2P 协议，非对称加密技术、共识机制、块链结构等多种技术，解决数据的可信问题。

![区块链](https://img-bed-1309306776.cos.ap-shanghai.myqcloud.com/img/20221014171115.png)

## 分布式存储系统

### 数据和系统类型

### 分布式文件系统

### 从单机到分布式 -- 具体如何分布式

## Flink实践

## Ceph 实践
